name: Salesforce Deploy with Auth URL

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Show project structure (debug)
        run: |
          pwd
          ls -la
          cat sfdx-project.json || echo "sfdx-project.json not found"

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Authenticate with Salesforce using SFDX Auth URL
        env:
          SF_AUTH_URL: ${{ secrets.SF_AUTH_URL }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
        run: |
          echo "$SF_AUTH_URL" > authurl.txt
          sf org login sfdx-url --sfdx-url-file authurl.txt --alias "$SF_USERNAME" --set-default
          sf org display --target-org "$SF_USERNAME"
          sf org list

      - name: Deploy to Salesforce
        env: 
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
        run: |
          sf project deploy start --source-dir firsttask --target-org "$SF_USERNAME" --wait 10 --verbose --ignore-conflicts 
